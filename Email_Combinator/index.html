<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Combined Tools</title>
    <style>
        /* Define a new, warm and earthy color palette */
        :root {
            --background-color: #FBF8F4;
            --card-background: #FFFFFF;
            --text-color: #4A4541;
            --subtle-text: #776C63;
            --border-color: #EAE0D5;
            --primary-color: #D96144; /* Terracotta */
            --secondary-color: #5E8BA8; /* Dusty Blue */
            --button-text-color: #ffffff;
            --font-family: 'Poppins', sans-serif;
            --box-shadow: 0 10px 30px rgba(10, 20, 30, 0.05);
        }
        
        /* General page layout and styling */
        body {
            font-family: var(--font-family);
            background: var(--background-color);
            color: var(--text-color);
            padding: 3rem 1.5rem;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* Grid container for all tools */
        .main-container {
            width: 100%;
            max-width: 1800px;
            display: grid;
            gap: 2.5rem;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
        
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        /* Card styling for each tool */
        .tool-card {
            background: var(--card-background);
            border-radius: 16px;
            box-shadow: var(--box-shadow);
            padding: 2.5rem;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        h1 {
            margin: 0 0 0.5rem;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .description {
            font-size: 1rem;
            color: var(--subtle-text);
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        input[type="file"],
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(217, 97, 68, 0.15);
        }

        .input-label {
            font-size: 0.9rem;
            color: var(--subtle-text);
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Button styles */
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            text-align: center;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: var(--button-text-color);
        }

        .btn-primary:hover {
            background-color: #B45037;
        }

        .btn-primary:disabled {
            background-color: #A3968C;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--button-text-color);
        }

        .btn-secondary:hover {
            background-color: #4A728E;
        }

        .output-section {
            margin-top: 2rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .output-section textarea {
            flex-grow: 1;
            min-height: 150px;
        }

        .actions-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .actions-group .btn {
            flex: 1;
        }
        
        /* Combined layout for output and export settings */
        .output-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .output-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .output-row .input-field, .output-row .actions-group {
            flex: 1;
            min-width: 200px;
        }

        .output-row .input-field input {
            width: 100%;
        }

        /* Scheduler specific styles */
        .tool-card.scheduler pre {
            white-space: pre-wrap;
            background: var(--background-color);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            min-height: 150px;
            font-family: monospace;
            overflow-x: auto;
            flex-grow: 1;
        }

        .tool-card.scheduler .settings {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .tool-card.scheduler .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .tool-card.scheduler .actions .btn {
            flex: 1;
            padding: 1rem 1.5rem;
        }
    </style>
</head>
<body>
    <div class="main-container">
        
        <div class="tool-card">
            <h1>XLSX Email Extractor</h1>
            <p class="description">
                Upload one or more Excel (.xlsx) files. The tool finds and lists unique emails
                from rows that contain the phrase "Contact file added successfully".
            </p>
            <div class="input-group">
                <label for="fileInput" class="input-label">Select XLSX files:</label>
                <input id="fileInput" type="file" accept=".xlsx,.xls" multiple />
                <label for="phrase" class="input-label">Filter Phrase:</label>
                <input id="phrase" type="text" placeholder="Phrase to match" value="Contact file added successfully" />
            </div>
            <button id="parseBtn" class="btn btn-primary">Extract Emails</button>
            <div class="output-section">
                <div class="output-container">
                    <label for="resultEmails" class="input-label">Extracted Emails (Unique):</label>
                    <textarea id="resultEmails" readonly placeholder="Emails will appear here..."></textarea>
                    
                    <div class="output-row">
                        <div class="input-field">
                            <label for="splitLines" class="input-label">Lines for Part1.txt (e.g., 5000):</label>
                            <input type="number" id="splitLines" value="5000" min="1">
                        </div>
                        <div class="actions-group">
                            <button id="shuffleBtn" class="btn btn-secondary">Shuffle</button>
                            <button id="copyBtn" class="btn btn-secondary">Copy All</button>
                            <button id="exportBtn" class="btn btn-secondary">Export Emails</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="exportStatus" style="margin-top: 20px;"></div>
        </div>
        
        <div class="tool-card">
            <h1>Email Combinator</h1>
            <p class="description">
                Generate email addresses by combining lists of usernames and domains, and include manual emails.
            </p>
            <div class="input-group">
                <div>
                    <label for="usernameInput" class="input-label">Usernames (semicolon-separated):</label>
                    <input type="text" id="usernameInput" placeholder="support; sales; info" value="" /> 
                </div>
                <div>
                    <label for="domainInput" class="input-label">Domains (one per line):</label>
                    <textarea id="domainInput" placeholder="google.com&#10;hotmail.com&#10;..."></textarea>
                </div>
                <div>
                    <label for="manualEmailInput" class="input-label">Manual Emails (one per line):</label>
                    <textarea id="manualEmailInput" placeholder="john@example.com&#10;jane@test.net&#10;..."></textarea>
                </div>
            </div>
            <div class="actions-group">
                <button id="generateBtn" class="btn btn-primary">
                    Generate Emails
                </button>
                <button id="downloadCombinatorCsvBtn" class="btn btn-secondary">
                    Download CSV
                </button>
            </div>
            <div class="output-section">
                <label for="outputArea" class="input-label">Generated & Manual Emails:</label>
                <textarea id="outputArea" readonly placeholder="Emails will appear here..."></textarea>
                <div class="actions-group">
                    <button id="copyCombinatorBtn" class="btn btn-secondary">Copy All</button>
                </div>
            </div>
        </div>
        
        <div class="tool-card scheduler">
            <h1>ID Pairing Scheduler</h1>
            <p class="description">
                Pair IDs and assign a schedule based on a start time, with one pair per minute increment.
            </p>
            <label class="input-label">Paste IDs (one per line)</label>
            <textarea id="inputIds" placeholder="101145741
101145734
101145750
101145761
101145700"></textarea>
            <div class="settings">
                <div>
                    <label class="input-label">Start hour (0-23)</label><br>
                    <input type="number" id="startHour" min="0" max="23" value="16">
                </div>
                <div>
                    <label class="input-label">Minute (0-59)</label><br>
                    <input type="number" id="minute" min="0" max="59" value="30">
                </div>
                <div>
                    <label><input type="checkbox" id="reverse" checked> Reverse order</label>
                </div>
                <div>
                    <button id="generate" class="btn btn-primary">Generate</button>
                </div>
            </div>
            <div class="output-section">
                <label class="input-label">Output</label>
                <pre id="output" contenteditable="false"></pre>
                <div class="actions">
                    <button id="copy" class="btn btn-secondary">Copy</button>
                    <button id="download" class="btn btn-secondary">Download .txt</button>
                    <button id="clear" class="btn btn-secondary">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // === COMMON FUNCTIONS ===
        function csvEscape(str) {
            if (str == null) return '';
            return '"' + String(str).replace(/"/g, '""') + '"'; 
        }

        function downloadFile(data, filename) {
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Generic function to copy text from an element, with a temporary button text change.
         * @param {HTMLElement} element The element to copy from (e.g., a textarea or pre tag).
         * @param {HTMLElement} button The button that was clicked.
         * @param {string} originalText The original text of the button.
         */
        function copyTextFromElement(element, button, originalText) {
            if (!element.textContent && !element.value) {
                console.error('Nothing to copy.');
                return;
            }

            // For textareas
            if (element.tagName === 'TEXTAREA') {
                element.select();
                // FIX: Set the selection range to the exact length of the value for reliable "Copy All"
                element.setSelectionRange(0, element.value.length); 
            }
            // For other elements like <pre>
            else {
                const range = document.createRange();
                range.selectNode(element);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
            }

            // Execute the copy command
            try {
                document.execCommand('copy');
                button.textContent = 'Copied!';
                setTimeout(() => button.textContent = originalText, 1200);
            } catch (err) {
                console.error('Failed to copy text:', err);
                button.textContent = 'Failed!';
                setTimeout(() => button.textContent = originalText, 1200);
            }

            // Clear the selection
            if (element.tagName === 'TEXTAREA') {
                element.blur();
            } else {
                window.getSelection().removeAllRanges();
            }
        }

        // === 1. XLSX Extractor Logic ===
        const fileInput = document.getElementById('fileInput');
        const parseBtn = document.getElementById('parseBtn');
        const phraseInput = document.getElementById('phrase');
        const resultEmails = document.getElementById('resultEmails');
        const copyBtn = document.getElementById('copyBtn');
        const shuffleBtn = document.getElementById('shuffleBtn'); // Get the new button
        const exportBtn = document.getElementById('exportBtn');
        const splitLinesInput = document.getElementById('splitLines');
        const exportStatusDiv = document.getElementById('exportStatus');

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                        resolve(json);
                    } catch (err) {
                        reject(new Error(`Error reading file "${file.name}": ${err.message}`));
                    }
                };
                reader.onerror = () => reject(new Error(`Error reading file "${file.name}".`));
                reader.readAsArrayBuffer(file);
            });
        }

        function findEmailsInRow(row) {
            const re = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
            const found = new Set();
            for (const k in row) {
                const v = String(row[k] || '');
                const m = v.match(re);
                if (m) m.forEach(x => found.add(x.toLowerCase()));
            }
            return Array.from(found);
        }

        parseBtn.addEventListener('click', async () => {
            const files = Array.from(fileInput.files);
            if (files.length === 0) {
                exportStatusDiv.textContent = 'Please choose one or more .xlsx files.';
                exportStatusDiv.style.color = 'var(--primary-color)';
                return;
            }

            parseBtn.disabled = true;
            parseBtn.textContent = 'Processing...';
            exportStatusDiv.textContent = '';

            try {
                const phrase = phraseInput.value.trim();
                const matchedEmails = new Set();

                for (const f of files) {
                    const rows = await readExcelFile(f);
                    for (const row of rows) {
                        const rowText = Object.values(row).map(String).join(' '); 
                        
                        if (rowText && rowText.includes(phrase)) {
                            const emails = findEmailsInRow(row);
                            emails.forEach(e => matchedEmails.add(e));
                        }
                    }
                }

                const uniqueEmails = Array.from(matchedEmails).sort();
                resultEmails.value = uniqueEmails.join('\n');
                exportStatusDiv.textContent = `${uniqueEmails.length} unique emails found from ${files.length} file(s) matching the phrase.`;
                exportStatusDiv.style.color = 'var(--primary-color)';

            } catch (err) {
                exportStatusDiv.textContent = 'An error occurred: ' + err.message;
                exportStatusDiv.style.color = 'var(--primary-color)';
            } finally {
                parseBtn.disabled = false;
                parseBtn.textContent = 'Extract Emails';
            }
        });

        copyBtn.addEventListener('click', () => {
            copyTextFromElement(resultEmails, copyBtn, 'Copy All');
        });

        shuffleBtn.addEventListener('click', () => {
            const emails = resultEmails.value.split('\n').filter(e => e.trim());
            
            // Fisher-Yates shuffle algorithm
            for (let i = emails.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [emails[i], emails[j]] = [emails[j], emails[i]];
            }

            resultEmails.value = emails.join('\n');
            shuffleBtn.textContent = 'Shuffled!';
            setTimeout(() => {
                shuffleBtn.textContent = 'Shuffle';
            }, 1200);
        });

        exportBtn.addEventListener('click', () => {
            const emails = resultEmails.value.split('\n').filter(email => email.trim());
            const splitLines = parseInt(splitLinesInput.value, 10);
            
            if (emails.length === 0) {
                exportStatusDiv.textContent = 'No emails to export.';
                exportStatusDiv.style.color = 'var(--primary-color)';
                return;
            }
            
            if (isNaN(splitLines) || splitLines <= 0) {
                exportStatusDiv.textContent = 'Please enter a valid number of lines for splitting.';
                exportStatusDiv.style.color = 'var(--primary-color)';
                return;
            }

            // Export all emails to 6k.txt, separated by semicolons
            downloadFile(emails.join(';'), '6k.txt');

            // Split and export the first chunk, separated by semicolons
            const data3k = emails.slice(0, splitLines).join(';');
            downloadFile(data3k, 'Part1.txt');

            // Split and export the last chunk, separated by semicolons
            const data3k2 = emails.slice(-splitLines).join(';');
            downloadFile(data3k2, 'Part2.txt');

            exportStatusDiv.textContent = `Successfully prepared and downloaded: 6k.txt, Part1.txt, and Part2.txt.`;
            exportStatusDiv.style.color = 'var(--primary-color)';
        });


        // === 2. Email Combinator Logic (GENERATED EMAILS ON TOP, MANUAL EMAILS AT THE BOTTOM) ===
        const usernameInput = document.getElementById('usernameInput');
        const domainInput = document.getElementById('domainInput');
        const manualEmailInput = document.getElementById('manualEmailInput');
        const generateBtn = document.getElementById('generateBtn');
        const outputArea = document.getElementById('outputArea');
        const copyCombinatorBtn = document.getElementById('copyCombinatorBtn');
        const downloadCombinatorCsvBtn = document.getElementById('downloadCombinatorCsvBtn');
        let fetchedNames = [];

        async function fetchRandomNames(count) {
            downloadCombinatorCsvBtn.disabled = true;
            downloadCombinatorCsvBtn.textContent = 'Loading...';
            try {
                const response = await fetch(`https://randomuser.me/api/?nat=us&results=${count}&inc=name`); 
                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                fetchedNames = data.results.map(user => ({
                    first: user.name.first,
                    last: user.name.last
                }));

            } catch (error) {
                console.error('Error fetching names, using default list:', error);
                const defaultNames = [
                    { first: "James", last: "Harlow" },
                    { first: "Liam", last: "Jones" },
                    { first: "Olivia", last: "Davis" },
                    { first: "Noah", last: "Garcia" }
                ];
                fetchedNames = defaultNames.slice(0, count);
            } finally {
                downloadCombinatorCsvBtn.disabled = false;
                downloadCombinatorCsvBtn.textContent = 'Download CSV';
            }
        }

        generateBtn.addEventListener('click', () => {
            const usernames = usernameInput.value
                .split(';')
                .map(username => username.trim())
                .filter(username => username);

            const domains = domainInput.value
                .split('\n')
                .map(domain => domain.trim())
                .filter(domain => domain);

            const manualEmails = manualEmailInput.value
                .split('\n')
                .map(email => email.trim().toLowerCase())
                .filter(email => email.includes('@') && email.includes('.'));

            const generatedEmails = [];
            for (const username of usernames) {
                for (const domain of domains) {
                    generatedEmails.push(`${username}@${domain}`.toLowerCase());
                }
            }
            
            // Combine generatedEmails first, then manualEmails.
            // This ensures Generated are on top, and Manual are on the bottom.
            const allEmailsSet = new Set([...generatedEmails, ...manualEmails]);
            
            // Convert Set back to an Array. We intentionally DO NOT use .sort() 
            // to preserve the Generated-first, Manual-last order.
            const finalEmails = Array.from(allEmailsSet); 

            if (finalEmails.length === 0) {
                outputArea.value = 'Please enter usernames and domains, or manual emails.';
                return;
            }
            
            outputArea.value = finalEmails.join('\n');
        });

        copyCombinatorBtn.addEventListener('click', () => {
            copyTextFromElement(outputArea, copyCombinatorBtn, 'Copy All');
        });

        downloadCombinatorCsvBtn.addEventListener('click', async () => {
            const emails = outputArea.value.split('\n').filter(email => email);
            
            if (emails.length === 0) {
                console.error('Please generate emails first.');
                return;
            }

            if (fetchedNames.length < emails.length) {
                await fetchRandomNames(emails.length);
            }

            if (fetchedNames.length === 0) {
                console.error('Cannot download CSV. Failed to get names.');
                return;
            }

            const csvHeader = "First Name;Middle Name;Last Name;Company;Job Title;Email;Home Email;Work Email;Phone;Home;Work;Pager;Fax;Mobile;Other;Home Address;Home City;Home State;Home ZIP;Home Country;Work Address;Work City;Work State;Work ZIP;Work Country;Other Street;Other City;Other State;Zip Code;Other Country;Birthday;Anniversary;Notes;website\n";
            
            const shuffledNames = [...fetchedNames].sort(() => 0.5 - Math.random());
            
            const csvRows = emails.map((email, index) => {
                const nameIndex = index % shuffledNames.length;
                const name = shuffledNames[nameIndex];
                const firstName = name.first;
                const lastName = name.last;
                
                return `${csvEscape(firstName)};;${csvEscape(lastName)};;;${csvEscape(email)};;;;;;;;;;;;;;;;;;;;;;;;;;;;`;
            });

            const csvContent = csvHeader + csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '1.csv'; 
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(link.href);
        });

        // === 3. ID Pairing Scheduler Logic ===
        function pad2(n){return String(n).padStart(2,'0')}

        function generateText(ids, startHour, minute){
            const lines = ["REPO LOOP SELENIUM : DONE", ""];

            for(let i=0, t=0; i<ids.length; i+=2, t++){
                const a = ids[i];
                const b = ids[i+1];
                
                const hour = (startHour + t) % 24;
                const min = (minute) % 60; 
                const hourStr = pad2(hour);
                const minStr = pad2(min);
                
                if(a && b){
                    lines.push(`${hourStr}h${minStr} :  ${a} + ${b}`);
                } else if(a){
                    lines.push(`${hourStr}h${minStr} :  ${a}`);
                }
            }
            return lines.join('\n');
        }

        const inputIds = document.getElementById('inputIds');
        const output = document.getElementById('output');

        document.getElementById('generate').addEventListener('click', ()=>{
            const raw = inputIds.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
            
            const reverse = document.getElementById('reverse').checked;
            let arr = raw.slice();

            if(reverse) arr = arr.reverse();

            const startHour = parseInt(document.getElementById('startHour').value)||0;
            const minute = parseInt(document.getElementById('minute').value)||0;

            const txt = generateText(arr, startHour, minute);
            output.textContent = txt;
        });

        document.getElementById('copy').addEventListener('click', () => {
            copyTextFromElement(output, document.getElementById('copy'), 'Copy');
        });

        document.getElementById('download').addEventListener('click', ()=>{
            const blob = new Blob([output.textContent||''],{type:'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'paired_schedule.txt';
            document.body.appendChild(a); 
            a.click(); 
            a.remove();
            URL.revokeObjectURL(url);
        });

        document.getElementById('clear').addEventListener('click', ()=>{
            output.textContent='';
            inputIds.value='';
        });
    </script>
</body>
</html>
